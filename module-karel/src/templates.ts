import { Partitions } from "./partitions";
import { StudentList } from "classroom-api";
import { Submission } from 'dt-types';
import { config } from './config'

export type S = Submission
const urls = {
	homework: 'https://freeuni-digital-technologies.github.io/homework/',
    web_homework: 'https://freeuni-digital-technologies.github.io/homework/web_hws.html'
}
// TODO рЃћрЃА рЃАрЃ»рЃЮрЃЉрЃА рЃарЃЮрЃЏ рЃАрЃ«рЃЋрЃљрЃњрЃљрЃю рЃўрЃДрЃЮрЃА. рЃБрЃЉрЃарЃљрЃџрЃЮрЃЊ submission-рЃА рЃЏрЃЮрЃДрЃЋрЃћрЃА
const students = new StudentList(config.STUDENTS_DATA_PATH)

function fileInfo(s: S) {
    return `
    ---

    рЃЦрЃЋрЃћрЃЏрЃЮрЃЌ рЃЉрЃЏрЃБрЃџрЃћрЃЉрЃў рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃа рЃљрЃарЃўрЃА. 
    рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃўрЃА рЃюрЃљрЃ«рЃЋрЃљ рЃЎрЃџрЃљрЃАрЃарЃБрЃЏрЃќрЃћ: ${s.alternateLink.replace(/\.com\/c\//, '.com/u/2/c/')} 
    рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃљ: ${s.attachment!.downloadUrl.replace(/authuser=0/, 'authuser=2')}
    `
}


// TODO рЃљрЃЦ рЃЌрЃљрЃЋрЃўрЃАрЃўрЃЌ рЃБрЃюрЃЊрЃљ рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃўрЃбрЃЮрЃА рЃЊрЃћрЃЊрЃџрЃљрЃўрЃюрЃљрЃЏрЃЊрЃћ рЃЊрЃарЃЮ рЃљрЃарЃўрЃА рЃЌрЃБ рЃљрЃарЃљ, рЃЎрЃЮрЃюрЃцрЃўрЃњрЃерЃў рЃгрЃћрЃарЃўрЃљ
const blocked = 'рЃљрЃЏ рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃўрЃА рЃњрЃљрЃЏрЃЮ рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃбрЃћрЃАрЃбрЃўрЃарЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ рЃюрЃљрЃЉрЃўрЃ»рЃќрЃћ рЃЋрЃћрЃа рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА рЃЊрЃљ рЃАрЃ«рЃЋрЃљ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃўрЃА рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃљ рЃфрЃюрЃЮрЃЉрЃўрЃџрЃў рЃљрЃа рЃљрЃарЃўрЃА. рЃЌрЃБ рЃЊрЃћрЃЊрЃџрЃљрЃўрЃюрЃљрЃЏрЃЊрЃћ рЃЊрЃарЃЮ рЃЊрЃљрЃарЃЕрЃљ, рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃбрЃЋрЃўрЃарЃЌрЃЮ. \
            \
            рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃћрЃЉрЃў!'

export type EmailTemplate = (s: S) => string

export const templates: Partitions<EmailTemplate> = {
    late: (s: S) => `
        ${summaries.greeting(s)},

        рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЊрЃљрЃњрЃЋрЃўрЃљрЃюрЃћрЃЉрЃўрЃЌ рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ рЃЊрЃљ рЃЦрЃБрЃџрЃљ рЃљрЃа рЃЕрЃљрЃњрЃћрЃЌрЃЋрЃџрЃћрЃЉрЃљ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃБрЃЎрЃБрЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃА рЃЏрЃўрЃќрЃюрЃўрЃЌ рЃњрЃўрЃњрЃќрЃљрЃЋрЃюрЃў рЃерЃћрЃЊрЃћрЃњрЃА:

        ${s.results}
        
        рЃўрЃљ
        
        ${fileInfo(s)}
    `,
    invalid: (s: S) => `
        ${summaries.greeting(s)},

        ${summaries.invalid(s)}

        рЃўрЃљ
        
        ${fileInfo(s)}
    `,

    // error/invalid рЃЏрЃћрЃАрЃўрЃ»рЃћрЃЉрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃћрЃарЃЌрЃњрЃљрЃю рЃњрЃљрЃгрЃћрЃарЃўрЃџрЃў рЃЊрЃљ рЃДрЃЋрЃћрЃџрЃљрЃА рЃЌрЃљрЃЋрЃўрЃАрЃў рЃЏрЃћрЃАрЃўрЃ»рЃў/рЃњрЃљрЃЏрЃЮрЃАрЃгрЃЮрЃарЃћрЃЉрЃљ рЃћрЃгрЃћрЃарЃЮрЃА
    error: (s: S) => `
        ${summaries.greeting(s)},

        ${summaries.error(s)}
        
        рЃўрЃљ
        
        ${fileInfo(s)}
    `,
    // TODO рЃърЃўрЃарЃЋрЃћрЃџрЃў/рЃЏрЃћрЃЮрЃарЃћ рЃЊрЃљ рЃљ.рЃе рЃЦрЃЮрЃюрЃЊрЃћрЃА рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљрЃАрЃљрЃф рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљрЃерЃў,
    // рЃљрЃАрЃћрЃЋрЃћ рЃџрЃўрЃюрЃЎрЃў рЃАрЃљрЃўрЃбрЃўрЃА.
    failed: (s: S) => {
        const failed = s.results.filter(r => !r.passed)
        const passed = s.results.filter(r => r.passed)
        const testCount = s.results.length
        const grade = passed.length/testCount*4
        return `
        ${summaries.greeting(s)},
        
        рЃерЃћрЃюрЃў рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЏрЃўрЃдрЃћрЃЉрЃБрЃџрЃўрЃљ рЃЊрЃљ рЃњрЃљрЃЊрЃўрЃА ${passed.length} рЃбрЃћрЃАрЃбрЃА ${testCount}-рЃЊрЃљрЃю. 
        рЃЦрЃБрЃџрЃљ рЃўрЃЦрЃюрЃћрЃЉрЃљ ${grade} 4-рЃЊрЃљрЃю. 

        рЃЦрЃЋрЃћрЃЏрЃЮрЃЌ рЃЊрЃљрЃЋрЃБрЃарЃЌрЃљрЃЋ, рЃарЃЮрЃЏрЃћрЃџрЃў рЃбрЃћрЃАрЃбрЃћрЃЉрЃў рЃЋрЃћрЃа рЃњрЃљрЃўрЃљрЃарЃљ рЃерЃћрЃюрЃЏрЃљ рЃЎрЃЮрЃЊрЃЏрЃљ. рЃЊрЃћрЃЊрЃџрЃљрЃўрЃюрЃљрЃЏрЃЊрЃћ рЃЌрЃБ рЃЊрЃарЃЮ рЃњрЃћрЃЦрЃюрЃћрЃЉрЃљ, рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљ рЃћрЃА рЃюрЃљрЃгрЃўрЃџрЃћрЃЉрЃўрЃф рЃњрЃљрЃЏрЃЮрЃљрЃАрЃгрЃЮрЃарЃЮ. 
рЃЌрЃБ рЃЌрЃЋрЃџрЃў рЃарЃЮрЃЏ рЃарЃљрЃЏрЃћ рЃљрЃарЃљрЃАрЃгрЃЮрЃарЃўрЃљ, рЃБрЃърЃљрЃАрЃБрЃ«рЃћ рЃљрЃЏ рЃЏрЃћрЃўрЃџрЃА, рЃЮрЃдрЃЮрЃюрЃЊ cc-рЃерЃў рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћ рЃњрЃўрЃњрЃў. 

        ${failed.map(t => t.message).join('\n***\n')}

        
        рЃўрЃљ
        
        ${fileInfo(s)}
    `},
    passed: (s: S) => `
        ${summaries.greeting(s)},

	   рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЕрЃљрЃЉрЃљрЃарЃћрЃЉрЃБрЃџрЃўрЃљ ­ЪЦ│ 

        рЃўрЃљ
    `

}


export const summaries = {
    greeting: (s: S) => {
    return `рЃњрЃљрЃЏрЃљрЃарЃ»рЃЮрЃЉрЃљ ${students.getStudentByEmail(s.emailId)?.georgianName}`
    },

    error: (s: S) => {
        return `
            рЃцрЃљрЃўрЃџрЃўрЃА рЃгрЃћрЃАрЃћрЃЉрЃўрЃф рЃАрЃарЃБрЃџрЃДрЃЮрЃцрЃўрЃџрЃљрЃЊ рЃњрЃљрЃЦрЃЋрЃА рЃЊрЃљрЃфрЃБрЃџрЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ 
            рЃАрЃўрЃюрЃбрЃљрЃЦрЃАрЃБрЃарЃў рЃљрЃю рЃАрЃ«рЃЋрЃљ рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃўрЃА рЃњрЃљрЃЏрЃЮ рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃљ рЃЎрЃЮрЃЊрЃА рЃЋрЃћрЃа рЃБрЃерЃЋрЃћрЃЉрЃА. 

            рЃЏрЃћрЃўрЃџрЃА рЃЌрЃљрЃю рЃЋрЃБрЃарЃЌрЃљрЃЋ рЃбрЃћрЃАрЃбрЃћрЃарЃўрЃА рЃЏрЃћрЃАрЃўрЃ»рЃА.
            
            ${urls.homework}

            ${s.results}

            ${blocked}
        `
    },

    invalid: (s: S) => {
        return `
            рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃљрЃарЃљрЃАрЃгрЃЮрЃа рЃцрЃЮрЃарЃЏрЃљрЃбрЃерЃўрЃљ рЃЊрЃљ рЃњрЃљрЃЏрЃАрЃгрЃЮрЃарЃћрЃЉрЃћрЃџрЃў рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃљ рЃЋрЃћрЃа рЃ«рЃАрЃюрЃўрЃА.
            - рЃљрЃарЃфрЃћрЃарЃЌ рЃцрЃљрЃўрЃџрЃА рЃљрЃа рЃБрЃюрЃЊрЃљ рЃЦрЃЮрЃюрЃЊрЃћрЃА рЃАрЃљрЃ«рЃћрЃџрЃў рЃерЃћрЃфрЃЋрЃџрЃўрЃџрЃў
            - рЃцрЃљрЃўрЃџрЃћрЃЉрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃЊрЃљрЃќрЃўрЃърЃБрЃџрЃў. рЃќрЃўрЃърЃў рЃерЃћрЃюрЃА email id-рЃўрЃА рЃБрЃюрЃЊрЃљ рЃерЃћрЃўрЃфрЃљрЃЋрЃЊрЃћрЃА
            рЃЊрЃљрЃќрЃўрЃърЃЋрЃљ рЃЌрЃБ рЃљрЃа рЃўрЃфрЃў, рЃўрЃюрЃАрЃбрЃарЃБрЃЦрЃфрЃўрЃљ рЃљрЃЏ рЃњрЃЋрЃћрЃарЃЊрЃќрЃћрЃљ: ${urls.web_homework}.

            ${s.results}
    `

    }

}

